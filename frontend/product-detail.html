<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đang tải sản phẩm... - Nhà Thuốc GB</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/style.css?v=1.5" />
  </head>
  <body>
    <div id="main-header"></div>

    <main>
      <div class="container">
        <div class="breadcrumbs" id="product-breadcrumbs">
          <a href="index.html">Trang chủ</a> /
          <a href="products.html">Sản phẩm</a> /
          <span>Đang tải...</span>
        </div>

        <div class="product-detail-container" id="product-detail-content">
          <p>Đang tải thông tin sản phẩm...</p>
        </div>
      </div>
    </main>

    <div id="main-footer"></div>

    <script src="assets/js/app.js"></script>
    <script>
      // Hàm chạy khi trang tải xong
      async function initProductDetailPage() {
        console.log("Đang khởi tạo trang chi tiết sản phẩm...");
        const urlParams = new URLSearchParams(window.location.search);
        const productSlug = urlParams.get("slug"); // Lấy slug từ URL

        if (!productSlug) {
          // Nếu không có slug, hiển thị lỗi và dừng
          document.getElementById("product-detail-content").innerHTML =
            '<p class="error-message">Lỗi: Không tìm thấy slug sản phẩm trong URL.</p>';
          document.title = "Lỗi - Nhà Thuốc GB";
          return;
        }

        await loadProductDetails(productSlug);
        await loadCategoriesDropdown(); // Tải danh mục cho header
        checkAuthStatus(); // Kiểm tra đăng nhập cho header
        // (Optional: await loadRelatedProducts(categoryId); )
      }

      // Hàm gọi API lấy chi tiết sản phẩm
      async function loadProductDetails(slug) {
        const contentDiv = document.getElementById("product-detail-content");
        const breadcrumbsSpan = document.querySelector(
          "#product-breadcrumbs span"
        );
        if (!contentDiv || !breadcrumbsSpan) return;

        try {
          const response = await apiFetch(
            `${API_URL}/products.php?action=detail&slug=${slug}`
          );
          const result = await response.json();

          if (result.status === "success" && result.data) {
            renderProductDetails(result.data, contentDiv);
            // Cập nhật title trang và breadcrumbs
            document.title = `${result.data.name} - Nhà Thuốc GB`;
            breadcrumbsSpan.textContent = result.data.name;
            // (Optional: loadRelatedProducts(result.data.category_id); )
          } else {
            contentDiv.innerHTML = `<p class="error-message">Lỗi: ${
              result.message || "Không tìm thấy sản phẩm."
            }</p>`;
            document.title = "Không tìm thấy sản phẩm - Nhà Thuốc GB";
            breadcrumbsSpan.textContent = "Không tìm thấy";
          }
        } catch (error) {
          console.error("Fetch error (Product Detail):", error);
          contentDiv.innerHTML = `<p class="error-message">Không thể tải thông tin sản phẩm. Vui lòng thử lại sau.</p>`;
          document.title = "Lỗi tải sản phẩm - Nhà Thuốc GB";
          breadcrumbsSpan.textContent = "Lỗi";
        }
      }

      // Hàm render chi tiết sản phẩm ra HTML
      function renderProductDetails(product, container) {
        let priceHtml = `<span class="current-price">${formatCurrency(
          product.price
        )}</span>`;
        let originalPriceHtml = ""; // Thêm biến cho giá gốc

        if (product.sale_price && product.sale_price < product.price) {
          priceHtml = `<span class="current-price">${formatCurrency(
            product.sale_price
          )}</span>`;
          originalPriceHtml = `<span class="original-price">${formatCurrency(
            product.price
          )}</span>`; // Giá gốc có gạch
        }

        // Xử lý đường dẫn ảnh
        let imagePath = product.image;
        if (
          imagePath &&
          typeof imagePath === "string" &&
          !imagePath.startsWith("products/")
        ) {
          imagePath = "products/" + imagePath;
        } else if (!imagePath) {
          imagePath = "placeholder.jpg";
        }
        const imageSrc = `../uploads/${imagePath}`;

        container.innerHTML = `
                <div class="product-detail-layout">
                    <div class="product-image-column">
                        <img src="${imageSrc}" alt="${
          product.name
        }" id="main-product-image" onerror="this.onerror=null; this.src='../uploads/placeholder.jpg'; this.style.objectFit='contain';">
                        </div>
                    <div class="product-info-column">
                        <h1>${product.name}</h1>
                        <p class="product-category">Danh mục: <a href="products.html?category_id=${
                          product.category_id
                        }">${product.category_name}</a></p>

                        <div class="price-section">
                             ${priceHtml}
                             ${originalPriceHtml}
                        </div>

                        <div class="short-description">
                            ${
                              product.description
                                ? `<p>${product.description.substring(
                                    0,
                                    150
                                  )}...</p>`
                                : "<p>Chưa có mô tả ngắn.</p>"
                            }
                        </div>

                        <div class="quantity-selector">
                            <label for="quantity">Số lượng:</label>
                            <button type="button" class="quantity-btn minus">-</button>
                            <input type="number" id="quantity" name="quantity" value="1" min="1" max="${
                              product.stock > 0 ? product.stock : 1
                            }">
                            <button type="button" class="quantity-btn plus">+</button>
                            <span class="stock-info">(${
                              product.stock > 0
                                ? `${product.stock} ${
                                    product.unit || ""
                                  } có sẵn`
                                : "Hết hàng"
                            })</span>
                        </div>

                        <button class="btn btn-primary btn-add-to-cart-detail" data-product-id="${
                          product.id
                        }" data-product-name="${product.name}" ${
          product.stock <= 0 ? "disabled" : ""
        }>
                           ${
                             product.stock > 0
                               ? '<i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng'
                               : "Đã hết hàng"
                           }
                        </button>

                        </div>
                </div>

                 <div class="product-full-details">
                      <h2>Thông tin chi tiết sản phẩm</h2>
                      <div class="detail-section">
                           <h3>Mô tả sản phẩm</h3>
                           ${
                             product.description
                               ? `<p>${product.description.replace(
                                   /\n/g,
                                   "<br>"
                                 )}</p>`
                               : "<p>Chưa có mô tả chi tiết.</p>"
                           }
                      </div>
                       <div class="detail-section">
                           <h3>Hướng dẫn sử dụng</h3>
                            ${
                              product.usage
                                ? `<p>${product.usage.replace(
                                    /\n/g,
                                    "<br>"
                                  )}</p>`
                                : "<p>Vui lòng xem trên bao bì sản phẩm hoặc tham khảo ý kiến bác sĩ/dược sĩ.</p>"
                            }
                       </div>
                       </div>
            `;

        // Gắn sự kiện cho nút tăng/giảm số lượng và nút Thêm vào giỏ
        attachQuantityEvents();
        attachDetailAddToCartEvent();
      }

      // Hàm gắn sự kiện cho nút +/- số lượng
      function attachQuantityEvents() {
        const minusBtn = document.querySelector(".quantity-btn.minus");
        const plusBtn = document.querySelector(".quantity-btn.plus");
        const quantityInput = document.getElementById("quantity");

        if (minusBtn && plusBtn && quantityInput) {
          minusBtn.addEventListener("click", () => {
            let currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
              quantityInput.value = currentValue - 1;
            }
          });

          plusBtn.addEventListener("click", () => {
            let currentValue = parseInt(quantityInput.value);
            let maxStock = parseInt(quantityInput.max);
            if (currentValue < maxStock) {
              quantityInput.value = currentValue + 1;
            }
          });

          // Ngăn nhập số lượng > tồn kho hoặc < 1
          quantityInput.addEventListener("change", () => {
            let currentValue = parseInt(quantityInput.value);
            let maxStock = parseInt(quantityInput.max);
            if (isNaN(currentValue) || currentValue < 1) {
              quantityInput.value = 1;
            } else if (currentValue > maxStock) {
              quantityInput.value = maxStock;
            }
          });
        }
      }

      // Hàm gắn sự kiện cho nút "Thêm vào giỏ" trên trang chi tiết
      function attachDetailAddToCartEvent() {
        const button = document.querySelector(".btn-add-to-cart-detail");
        if (button) {
          button.addEventListener("click", async (e) => {
            const productId = e.target.dataset.productId;
            const productName = e.target.dataset.productName;
            const quantityInput = document.getElementById("quantity");
            const quantity = parseInt(quantityInput.value) || 1;

            // Gọi API thêm vào giỏ
            try {
              const response = await apiFetch(
                `${API_URL}/cart.php?action=add`,
                {
                  method: "POST",
                  body: { product_id: productId, quantity: quantity },
                }
              );
              const result = await response.json();

              if (result.status === "success") {
                alert(`Đã thêm ${quantity} "${productName}" vào giỏ hàng!`);
                // (Tùy chọn: chuyển đến trang giỏ hàng? window.location.href = 'cart.html';)
              } else if (response.status === 401) {
                alert("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng.");
                window.location.href = "login.html";
              } else {
                alert(`Lỗi khi thêm vào giỏ: ${result.message}`);
              }
            } catch (error) {
              console.error("Lỗi khi thêm vào giỏ:", error);
              alert("Đã xảy ra lỗi kết nối. Vui lòng thử lại.");
            }
          });
        }
      }

      // --- Các hàm copy từ index.html (loadCategoriesDropdown, checkAuthStatus, handleLogout) ---
      // Hàm tải danh mục vào dropdown header
      async function loadCategoriesDropdown() {
        /* ... (Giữ nguyên code từ index.html) ... */
      }
      // Hàm kiểm tra đăng nhập header
      async function checkAuthStatus() {
        /* ... (Giữ nguyên code từ index.html) ... */
      }
      // Hàm xử lý logout
      async function handleLogout(e) {
        /* ... (Giữ nguyên code từ index.html) ... */
      }

      // Chạy hàm init khi trang tải xong
      document.addEventListener("DOMContentLoaded", initProductDetailPage);
    </script>
  </body>
</html>
